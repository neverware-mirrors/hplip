#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix possible privilege escalation via policykit UID lookup race
# Author: Colin Walters <walters@verbum.org>

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' hplip-3.12.2~/base/pkit.py hplip-3.12.2/base/pkit.py
--- hplip-3.12.2~/base/pkit.py	2012-02-01 06:53:55.000000000 -0500
+++ hplip-3.12.2/base/pkit.py	2013-09-13 11:39:14.248834676 -0400
@@ -175,15 +175,10 @@
                                     "/org/freedesktop/PolicyKit1/Authority",
                                     "org.freedesktop.PolicyKit1.Authority")
         policy_kit = dbus.Interface(obj, "org.freedesktop.PolicyKit1.Authority")
-        info = dbus.Interface(connection.get_object("org.freedesktop.DBus",
-                                                    "/org/freedesktop/DBus/Bus",
-                                                    False),
-                              "org.freedesktop.DBus")
-        pid = info.GetConnectionUnixProcessID(sender)
         
         subject = (
-            'unix-process',
-            { 'pid' : dbus.UInt32(pid, variant_level = 1) }
+            'system-bus-name',
+            { 'name' : dbus.String(sender, variant_level = 1) }
         )
         details = { '' : '' }
         flags = dbus.UInt32(1)         # AllowUserInteraction = 0x00000001
